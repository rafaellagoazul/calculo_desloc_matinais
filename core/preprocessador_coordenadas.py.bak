# core/preprocessador_coordenadas.py
from pathlib import Path
import pandas as pd

from core.coord_diagnostico import diagnosticar_coordenada
from ui.map_preview_modal import abrir_mapa_validacao


class PreProcessadorCoordenadas:
    def __init__(self, arquivo_excel: Path, on_log=None):
        self.arquivo_excel = Path(arquivo_excel)
        self.on_log = on_log or (lambda msg: None)

    # ======================================================
    def processar(self) -> pd.DataFrame:
        """
        Retorna um DataFrame com coordenadas validadas
        ou lanÃ§a exceÃ§Ã£o se o usuÃ¡rio cancelar.
        """
        self.on_log("ðŸ”Ž Iniciando diagnÃ³stico de coordenadas")

        df = pd.read_excel(self.arquivo_excel)

        problemas = []
        linhas_ok = []

        for idx, row in df.iterrows():
            linha_excel = idx + 2

            diag_casa = diagnosticar_coordenada(row["CASA VEND"], "CASA VEND")
            diag_dist = diagnosticar_coordenada(row["DISTRIBUIDOR"], "DISTRIBUIDOR")
            diag_cli  = diagnosticar_coordenada(row["1ÂºCLIENTE"], "1ÂºCLIENTE")

            diags = [
                ("CASA VEND", diag_casa),
                ("DISTRIBUIDOR", diag_dist),
                ("1ÂºCLIENTE", diag_cli),
            ]

            linha_tem_erro = False

            for campo, d in diags:
                if d["nivel"] in ("erro", "alerta"):
                    problemas.append({
                        "linha": linha_excel,
                        "campo": campo,
                        "raw": d["raw"],
                        "lat": d["lat"],
                        "lon": d["lon"],
                        "nivel": d["nivel"],
                        "motivo": d["motivo"],
                    })

                    if d["nivel"] == "erro":
                        linha_tem_erro = True

            if not linha_tem_erro:
                linhas_ok.append(idx)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Se nÃ£o hÃ¡ problemas â†’ segue direto
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if not problemas:
            self.on_log("âœ” Nenhum problema de coordenada encontrado")
            return df

        self.on_log(f"âš  {len(problemas)} problemas encontrados â€” abrindo mapa")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # MAPA
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        corrigidos = abrir_mapa_validacao(problemas)

        if corrigidos is None:
            raise RuntimeError("ValidaÃ§Ã£o cancelada pelo usuÃ¡rio")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # APLICA CORREÃ‡Ã•ES
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for p in corrigidos:
            idx = p["linha"] - 2
            campo = p["campo"]
            lat = p["lat"]
            lon = p["lon"]

            if lat is None or lon is None:
                continue

            df.at[idx, campo] = f"{lat}, {lon}"

        self.on_log("âœ” Coordenadas corrigidas e confirmadas")
        return df
