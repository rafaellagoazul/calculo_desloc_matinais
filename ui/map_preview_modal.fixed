# REMOVIDO: from pathlib import Path
# map_preview_modal.py
# REMOVIDO: import json
# REMOVIDO: import tempfile
# REMOVIDO: import webview


HTML = """
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>ValidaÃ§Ã£o de Coordenadas</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  margin:0;
  height:100%;
  font-family: Arial;
}
#map { height:100%; }

.panel {
  position:absolute;
  top:10px;
  right:10px;
  width:320px;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.3);
  font-size:13px;
  z-index:1000;
}

input, button {
  width:100%;
  margin:4px 0;
  padding:6px;
}

.badge {
  display:inline-block;
  padding:2px 6px;
  border-radius:4px;
  color:#fff;
  font-size:11px;
}

.badge.erro { background:#e74c3c; }
.badge.alerta { background:#f1c40f; color:#000; }

.resumo {
  font-size:12px;
  margin-bottom:6px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
  <div class="resumo" id="resumo"></div>

  <b>Buscar endereÃ§o</b>
  <input id="busca" placeholder="Rua, cidade..."/>
  <button onclick="buscar()">ğŸ” Buscar</button>

  <hr>

  <button onclick="confirmar()">âœ… Confirmar correÃ§Ãµes</button>
  <button onclick="cancelar()">âŒ Cancelar</button>
</div>

<script>
const pontos = __PONTOS__;

// â”€â”€â”€ ÃCONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const iconErro = L.icon({
  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red.png',
  iconSize: [32, 32],
  iconAnchor: [16, 32]
});

const iconAlerta = L.icon({
  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/yellow.png',
  iconSize: [32, 32],
  iconAnchor: [16, 32]
});

// â”€â”€â”€ MAPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map');

L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom: 19 }
).addTo(map);

const bounds = [];

// â”€â”€â”€ POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function popupHtml(p) {
  return `
    <b>Linha ${p.linha}</b><br>
    <b>${p.campo}</b><br>
    <span class="badge ${p.nivel}">${p.motivo}</span><br><br>

    <i>Valor original:</i><br>
    <code>${p.raw ?? ""}</code><br><br>

    Latitude:<br>
    <input id="lat_${p.id}" value="${p.lat ?? ""}"><br>
    Longitude:<br>
    <input id="lon_${p.id}" value="${p.lon ?? ""}"><br>

    <button onclick="aplicar(${p.id})">âœï¸ Aplicar</button>
    <button onclick="snap(${p.id})">ğŸ“ Snap rua</button>
  `;
}

// â”€â”€â”€ MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pontos.forEach((p, idx) => {
  p.id = idx;

  // â— NÃƒO cria marker se nÃ£o houver coordenada
  if (p.lat === null || p.lon === null) return;

  const icon = p.nivel === "erro" ? iconErro : iconAlerta;

  const marker = L.marker([p.lat, p.lon], {
    draggable: true,
    icon: icon
  }).addTo(map);

  marker.bindPopup(() => popupHtml(p));

  marker.on("dragend", () => {
    const ll = marker.getLatLng();
    p.lat = ll.lat;
    p.lon = ll.lng;
  });

  p._marker = marker;
  bounds.push([p.lat, p.lon]);
});

// â”€â”€â”€ ZOOM INICIAL INTELIGENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (bounds.length) {
  map.fitBounds(bounds, { padding:[60,60] });
} else {
  map.setView([-15, -55], 4);
}

// â”€â”€â”€ RESUMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function atualizarResumo() {
  const erros = pontos.filter(p => p.nivel === "erro").length;
  const alertas = pontos.filter(p => p.nivel === "alerta").length;

  document.getElementById("resumo").innerHTML =
    `ğŸ”´ Erros: <b>${erros}</b><br>` +
    `ğŸŸ¡ Alertas: <b>${alertas}</b>`;
}
atualizarResumo();

// â”€â”€â”€ AÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.aplicar = function(id) {
  const p = pontos.find(x => x.id === id);
  const lat = parseFloat(document.getElementById("lat_"+id).value);
  const lon = parseFloat(document.getElementById("lon_"+id).value);

  if (isNaN(lat) || isNaN(lon)) {
    alert("Coordenadas invÃ¡lidas");
    return;
  }

  p.lat = lat;
  p.lon = lon;

  if (p._marker) {
    p._marker.setLatLng([lat, lon]);
  } else {
    location.reload();
  }
};

window.buscar = async function() {
  const q = document.getElementById("busca").value;
  if (!q) return;

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data.length) {
    alert("EndereÃ§o nÃ£o encontrado");
    return;
  }

  map.setView([data[0].lat, data[0].lon], 17);
};

window.snap = async function(id) {
  const p = pontos.find(x => x.id === id);
  if (p.lat === null || p.lon === null) return;

  const url = `https://router.project-osrm.org/nearest/v1/driving/${p.lon},${p.lat}`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data.waypoints || !data.waypoints.length) {
    alert("Snap nÃ£o encontrado");
    return;
  }

  const loc = data.waypoints[0].location;
  p.lon = loc[0];
  p.lat = loc[1];
  p._marker.setLatLng([p.lat, p.lon]);
};

// â”€â”€â”€ CONFIRMAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmar() {
  const saida = pontos.map(p => ({
    linha: p.linha,
    campo: p.campo,
    lat: p.lat,
    lon: p.lon
  }));
  window.pywebview.api.confirmar(saida);
}

function cancelar() {
  window.pywebview.api.cancelar();
}
</script>

</body>
</html>
"""


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PYTHON API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Api:
    def __init__(self):
        self.confirmado = False
        self.resultado = None

    def confirmar(self, pontos):
        self.confirmado = True
        self.resultado = pontos
        webview.destroy_window()

    def cancelar(self):
        self.confirmado = False
        webview.destroy_window()


def abrir_mapa_validacao(pontos: list[dict]):
    """
    Abre mapa para correÃ§Ã£o de coordenadas diagnosticadas.
    Retorna lista corrigida ou None se cancelado.
    """
    if not pontos:
        return []

    api = Api()
    html = HTML.replace("__PONTOS__", json.dumps(pontos))

    with tempfile.NamedTemporaryFile(
        delete=False,
        suffix=".html",
        encoding="utf-8",
        mode="w"
    ) as f:
        f.write(html)
        caminho = Path(f.name)

    webview.create_window(
        "ValidaÃ§Ã£o de Coordenadas",
        caminho.as_uri(),
        js_api=api,
        width=1250,
        height=740
    )

    webview.start()

    if not api.confirmado:
        return None

    return api.resultado